@using Allup_Service.Dtos.CommentDtos
@model List<CommentGetDto>

@{
    var averageRating = Model.Any() ? Model.Average(x => x.Rating) : 0;
    var ratingCounts = new int[5]; // 0-4: 1-5 ulduz

    foreach (var comment in Model)
    {
        if (comment.Rating >= 1 && comment.Rating <= 5)
        {
            ratingCounts[comment.Rating - 1]++;
        }
    }

    int totalRatings = Model.Count;
}


<h5 class="mt-4">Comments</h5>

@if (Model.Any())
{
    <div class="average-rating">
        <h4 class="rating-overall">@averageRating.ToString("0.0") <span>(Overall)</span></h4>
        <p>Based on @totalRatings Comment@(totalRatings > 1 ? "s" : "")</p>
    </div>

    <div class="rating-list d-flex flex-wrap">
        @for (int i = 5; i >= 1; i--)
        {
            <div class="single-rating">
                @for (int j = 1; j <= 5; j++)
                {
                    if (j <= i)
                    {
                        <i class="fas fa-star"></i>
                    }
                    else
                    {
                        <i class="far fa-star"></i>
                    }
                }
                <span>(@ratingCounts[i - 1])</span>
            </div>
        }
    </div>

    <div class="rating-items mt-4">
        @foreach (var comment in Model)
        {
            <div class="single-rating-item mb-4">
                <div class="rating-author d-flex flex-wrap align-items-center justify-content-between">
                    <h4 class="author-name">
                        @(comment.AppUser?.Username ?? "Anonymous")
                    </h4>
                    <ul class="rating-star d-flex">
                        @for (int i = 1; i <= 5; i++)
                        {
                            if (i <= comment.Rating)
                            {
                                <li><i class="fas fa-star"></i></li>
                            }
                            else
                            {
                                <li><i class="far fa-star"></i></li>
                            }
                        }
                        <li><span> (@comment.Rating)</span></li>
                    </ul>
                </div>
                <p>@comment.Text</p>

                @if (comment.Children.Any())
                {
                    <div class="replies pl-3 border-left mt-2">
                        @foreach (var reply in comment.Children)
                        {
                            <div class="reply mb-2">
                                <strong>@(reply.AppUser?.Username ?? "Anonymous")</strong>
                                <small class="text-muted">(@reply.CreatedAt.ToString("g"))</small>
                                <p>@reply.Text</p>
                            </div>
                        }
                    </div>
                }
            </div>
        }
    </div>
}
else
{
    <p>No comments yet. Be the first to leave a reply!</p>
}
