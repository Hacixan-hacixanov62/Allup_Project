@using Allup_Service.Dtos.CommentDtos
@model List<CommentGetDto>

@{
    var averageRating = Model.Any() ? Model.Average(x => x.Rating) : 0;
    var ratingCounts = new int[5]; // 0-4: 1-5 ulduz

    foreach (var comment in Model)
    {
        if (comment.Rating >= 1 && comment.Rating <= 5)
        {
            ratingCounts[comment.Rating - 1]++;
        }
    }

    int totalRatings = Model.Count;
}


<h5 class="mt-4">Comments</h5>

@if (Model.Any())
{
    <div class="average-rating">
        <h4 class="rating-overall">@averageRating.ToString("0.0") <span>(Overall)</span></h4>
        <p>Based on @totalRatings Comment@(totalRatings > 1 ? "s" : "")</p>
    </div>

    <div class="rating-list d-flex flex-wrap">
        @for (int i = 5; i >= 1; i--)
        {
            <div class="single-rating">
                @for (int j = 1; j <= 5; j++)
                {
                    if (j <= i)
                    {
                        <i class="fas fa-star"></i>
                    }
                    else
                    {
                        <i class="far fa-star"></i>
                    }
                }
                <span>(@ratingCounts[i - 1])</span>
            </div>
        }
    </div>

    <div class="rating-items mt-4">
        @foreach (var comment in Model)
        {
            <div class="single-rating-item mb-4">
                <div class="rating-author d-flex flex-wrap align-items-center justify-content-between">
                    <h4 class="author-name">
                        @(comment.AppUser?.Username ?? "Anonymous")<small class="text-muted">@comment.CreatedAt.ToString("dd MMM yyyy HH:mm")</small>
                    </h4>

                    <ul class="rating-star d-flex">
                        @for (int i = 1; i <= 5; i++)
                        {
                            if (i <= comment.Rating)
                            {
                                <li><i class="fas fa-star"></i></li>
                            }
                            else
                            {
                                <li><i class="far fa-star"></i></li>
                            }
                        }
                        <li><span> (@comment.Rating)</span></li>
                    </ul>
                </div>
                <p>@comment.Text</p>
                <div class="mt-2">
                    @* Delete düyməsi *@
                    @if (User.Identity.IsAuthenticated && comment.AppUserId == User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value)
                    {
                        <form class="delete-comment-form" method="post" asp-controller="Shop" asp-action="DeleteComment" style="display:inline;">
                            <input type="hidden" name="id" value="@comment.Id" />
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                        </form>

                    }

                    @* Reply düyməsi *@
                    @if (User.Identity.IsAuthenticated)
                    {
                        <button type="button" class="btn btn-sm btn-secondary" onclick="toggleReplyForm(@comment.Id)">Reply</button>
                        @* Reply formu (ilk öncə gizlədilmiş) *@
                        <div id="reply-form-@comment.Id" class="mt-2" style="display:none;">
                            <form asp-action="CreateComment" method="post">
                                <input type="hidden" name="ProductId" value="@comment.ProductId" />
                                <input type="hidden" name="ParentId" value="@comment.Id" />
                                <div class="single-form">
                                    <textarea name="Text" class="form-control" placeholder="Write your reply"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary mt-1">Submit Reply</button>
                            </form>
                        </div>
                    }

                    @if (comment.Children.Any())
                    {
                        <div class="replies pl-3 border-left mt-2">
                            @foreach (var reply in comment.Children)
                            {
                                <div class="reply mb-2">
                                    <strong>@(reply.AppUser?.Username ?? "Anonymous")</strong>
                                    <small class="text-muted">(@reply.CreatedAt.ToString("g"))</small>
                                    <p>@reply.Text</p>
                                </div>
                            }
                        </div>
                    }
                </div>

              
              
            </div>
        }
    </div>
}
else
{
    <p>No comments yet. Be the first to leave a reply!</p>
}

<script>
    function toggleReplyForm(commentId) {
        var form = document.getElementById('reply-form-' + commentId);
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }
</script>

<script>
        $(document).on("submit", ".delete-comment-form", function (e) {
        e.preventDefault();
        var form = $(this);
        $.post(form.attr("action"), form.serialize(), function () {
            form.closest(".single-rating-item").remove();
        });
    });

</script>